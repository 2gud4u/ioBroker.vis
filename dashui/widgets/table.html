<script language="javascript">
    // Following classes shoud be used if variable table_class="tclass"
    // <table class="tclass">
    //    <tr class="tclass-th">
    //       <th class="tclass-th1">Time</th>
    //       <th class="tclass-th2">Event</th>
    //    </tr>
    //    <tr class="tclass-tr tclass-tr-even">
    //       <td>12:34:34</td>
    //       <td>Door opened</td>
    //    </tr>
    //    <tr class="tclass-tr tclass-tr-odd">
    //       <td>12:34:35</td>
    //       <td>Door closed</td>
    //    </tr>
    //    <tr class="tclass-tr tclass-tr-even tclass-tr-selected">
    //       <td>12:34:36</td>
    //       <td>Window opened</td>
    //    </tr>
    // </table>
    //
    // following json string is expected:
    //    '[\
    //       {"Time": "12:34:34", "Event", "Door opened", "_data":{"Type": "1", "Event" : "SomeEvent1"}},\
    //       {"Time": "12:34:35", "Event", "Door closed", "_data":{"Type": "2", "Event" : "SomeEvent2"}},\
    //       {"Time": "12:34:36", "Event", "Window opened", "_data":{"Type": "3", "Event" : "SomeEvent3"}}\
    //     ]'
    //
    //  If _data object found and detailed_wid is defined
    //  following object will be created by selecting of one row:
    // <table class="tclass-detail">
    //     <tr class="tclass-detail-tr tclass-detail-tr-even"><td class="tclass-detail-td-name">Type</td><td class="tclass-detail-td-value">1</td></tr>
    //     <tr class="tclass-detail-tr tclass-detail-tr-odd"><td class="tclass-detail-td-name">Event</td><td class="tclass-detail-td-value">SomeEvent1</td></tr>
    // </table>


    var tableElements = [];

    // Register callback in dashUI
    function initTable () {
        if (!dui.binds.table) {
            dui.binds.table = true;
            dui.registerOnChange (onchangeTable, null);
            console.log("table");
        }
    }

    function registerTObjIds (wid, objId) {
        if (typeof objId == "object" || typeof objId == "array") {
            for (var i = 0, len = objId.length; i < len; i++)
                if (objId[i] && (!tableElements[objId[i]] || tableElements[objId[i]].indexOf (wid) == -1)) {
                    if (!tableElements[objId[i]]) {
                        tableElements[objId[i]] = [wid];
                    }
                    else {
                        tableElements[objId[i]].push (wid);
                    }
                }
        }
        else
        if (!tableElements[objId] || tableElements[objId].indexOf (wid) == -1) {
            if (!tableElements[objId]) {
                tableElements[objId] = [wid];
            }
            else {
                tableElements[objId].push (wid);
            }
        }
    }

    function onchangeTable (arg, objId, newEvent, isFromDevice, lastchange) {
        if (tableElements[objId]) {
            for (var i = 0, len = tableElements[objId].length; i < len; i++) {
                var elem = document.getElementById (tableElements[objId][i]);
                if (elem) {
                    if (elem.tableChanged) {
                        elem.tableChanged (objId, newEvent);
                    }
                }
            }
        }
    }

    // Show detailed information
    function onRowClick () {
        var id = $(this).attr('data-index');
        var options = this._parent._options;
        // Deselect all rows
        $('.' + this._parent._wid + '-id').removeClass (options.tclass + '-tr-selected');
        // Select a new one
        $(this).addClass(options.tclass + '-tr-selected');

        // Get container for detailed information
        var el = document.getElementById (options.detailed_wid);
        if (el && this._data) {
            var text = "";
            var print = null;
            // Try to find special attributes starting with '_'
            for (var obj in this._data) {
                if (obj.length > 0 && obj[0] == '_') {
                    text += '<table class="'+options.tclass+'-detail">';
                    // Show this object
                    var r = 0;
                    // Go through all attributes
                    for (var odata in this._data[obj]) {
                        var val = this._data[obj][odata];
                        if (odata.length > 1 && odata[0] == '_') {
                            continue;
                        }
                        text += '<tr class="'+options.tclass+'-detail-tr '+options.tclass+'-detail-tr-'+((r%2) ? 'odd' : 'even')+'"><td class="'+options.tclass+'-detail-td-name">'+odata+'</td>' +
                                '<td class="'+options.tclass+'-detail-td-value">'+val+'</td></tr>';
                        if (val && val.length > 6 && val.substring(val.length - 6) == '&nbsp;') {
                            text += '<tr class="'+options.tclass+'-detail-tr"><td colspan="2">&nbsp;</td></tr>';
                        }
                        r++;
                    }
                    text += '</table>';
                }
            }
            // If no special _data object found => show standart elements
            if (!text) {
                text = '<table class="'+options.tclass+'-detail">';
                // Go through all attributes
                var r = 0;
                for (var obj in this._data) {
                    // Show this object
                    if (obj.length > 1 && obj[0] == '_') {
                        continue;
                    }

                    text += '<tr class="'+options.tclass+'-detail-tr '+options.tclass+'-detail-tr-'+((r%2) ? 'odd' : 'even')+'"><td class="'+options.tclass+'-detail-td-name">'+obj+'</td>' +
                            '<td class="'+options.tclass+'-detail-td-value">'+this._data[obj]+'</td></tr>';

                    if (val.length > 6 && val.substring(val.length - 6) == '&nbsp;') {
                        text += '<tr class="'+options.tclass+'-detail-tr"><td colspan="2">&nbsp;</td></tr>';
                    }
                    r++;
                }
                text += '</table>';
            }

            $(el).html (text);

            if (options.btn_print) {
                $(el).append ('<button id="print_'+this._parent._wid+'" class="'+options.tclass+'-print-button">' + options.btn_print + '</button>');
                var btn = document.getElementById ('print_'+this._parent._wid);
                btn._parent = this._parent;
                btn._print_id = this._data._print_id || JSON.stringify(this._data);

                if (btn && dui.urlParams['edit'] !== "") {
                    $(btn).bind('click', function () {
                        if (this._parent._options.ack_id) {
                            localData.setValue(this._parent._options.ack_id, this._print_id);
                        }

                        if (this._parent._options.view_for_print) {
                            dui.changeView(this._parent._options.view_for_print);
                        }
                        setTimeout(function () {
                            window.print();
                            window.location.reload()
                        }, 500);
                    });
                }
            }
        }
    }

    function showTable (view, wid, options) {
        initTable();
        options.tclass = options.tclass || 'tclass';

        if (options.event_id) {
            registerTObjIds(wid, options.event_id);
        }

        // Set default width and height
        var style = dui.views[view].widgets[wid] ? dui.views[view].widgets[wid].style : {};
        style.width = style.width || options.defaultWidth;
        style.height = style.height || options.defaultHeight;

        // read actual table as json string
        var tableJson = options.table_id ? localData.uiState.attr('_' + options.table_id + '.Value') : null;
        var table = [];
        if (tableJson) {
            try {
                table = JSON.parse(tableJson);
            }
            catch (e) {
                console.log ("showTable: Cannot parse json table");
                table = [];
            }
        }

        // Create widget container
        $('#' + wid).remove();
        $('#duiview_' + view).append('<div class="dashui-widget ' + (options._class || "") + '" id="' + wid + '" data-hm-id="' + options.table_id + '" ></div>');
        var elem = document.getElementById(wid);
        if (style) {
            $(elem).css(style);
        }

        // Start creation of table
        var text = '<table id="t' + wid + '" class="' + options.tclass + '">';
        var headerDone = false;
        var j = 0;
        // Go through all lines
        for (var i = 0, len = table.length; i < len; i++) {
            if (!table[i]) continue;
            //  Create table header
            if (!headerDone) {
                text += '<tr class="' + options.tclass + '-th">';
                var k = 1;
                for (var obj in table[i]) {
                    if (obj.length > 0 && obj[0] == '_') {
                        continue;
                    }
                    text += '<th class="' + options.tclass + '-th' + k + '">' + obj + '</th>';
                    k++;
                }

                text += '</tr>';
                headerDone = true;
            }

            // Create row
            text += '<tr class="' + options.tclass + '-tr ' + options.tclass + ((j % 2) ? '-tr-even' : '-tr-odd') + ' ' + wid + '-id" id="tr_' + wid + '' + i + '" data-index="' + i + '">';
            for (var obj in table[i]) {
                if (obj.length > 0 && obj[0] == '_') {
                    continue;
                }
                text += '<td>' + table[i][obj] + '</td>';
            }
            text += '</tr>';
            j++;
        }
        text += '</table>';
        // Insert table into container
        $(elem).append(text);
        elem._options = options;
        elem._wid     = wid;

        // If detailed information desired
        if (options.detailed_wid) {
            // Bind on click event for every row
            $('.' + wid + '-id').bind("click", onRowClick);

            // Set additional data for every row
            for (var i = 0, len = table.length; i < len; i++) {
                if (!table[i]) continue;
                var el = document.getElementById('tr_' + wid + '' + i);
                if (el) {
                    el._data   = table[i];
                    el._parent = elem;
                }
            }
        }

        // Remember index to calculate even or odd
        elem._idx = options.new_on_top ? 0 : j+1;

        // New event coming
        elem.tableChanged = function (objId, _newEvent) {
            var newEvent;
            // Convert event to json
            if (_newEvent) {
                try {
                    newEvent = JSON.parse(_newEvent);
                }
                catch (e)
                {
                    console.log ("elem.tableChanged: Cannot parse json new event " + _newEvent);
                    return;
                }
            }
            else
                return;

            this._idx++;

            var text = '<tr class="' + options.tclass + '-tr ' + options.tclass + ((this._idx % 2) ? '-tr-even' : '-tr-odd') + ' ' + wid + '-id" id="tr_' + wid + '' + this._idx + '" data-index="' + this._idx + '">';
            for (var obj in newEvent) {
                if (obj.length > 0 && obj[0] == '_') {
                    continue;
                }
                text += '<td>' + newEvent[obj] + '</td>';
            }
            text += '</tr>';

            if (this._options.new_on_top) {
                $('#t'+this.id + ' tr:first').after(text);
            }
            else {
                $('#t'+this.id).append (text);
            }

            if (this._options.detailed_wid) {
                var el = document.getElementById('tr_' + wid + '' + this._idx);
                if (el) {
                    el._data         = newEvent;
                    el._parent       = this;
                }
                $(el).bind("click", onRowClick);
            }
        }
    }

</script>

<script type="text/ejs" id="tplTableBody" class="dashui-tpl" data-dashui-set="table" data-dashui-name="Table" data-dashui-attrs="table_id/id;event_id/id;table_class;detailed_wid;new_on_top/checkbox;btn_print;view_for_print/views;ack_id/id">
    <%
        var options =  {
            _class: this.data.attr('class'),
            style: this.data.attr('style'),
            table_id: this.data.attr('table_id'),
            event_id: this.data.attr('event_id'),
            new_on_top: this.data.attr('new_on_top'),
            tclass: this.data.attr('table_class'),
            detailed_wid: this.data.attr('detailed_wid'),
            btn_print: this.data.attr('btn_print'),
            view_for_print: this.data.attr('view_for_print'),
            ack_id: this.data.attr('ack_id'),
            defaultWidth: 200,
            defaultHeight: 200
        };
        showTable(this.view, this.data.attr('wid'), options); %>
</script>