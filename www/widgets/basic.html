<script type="text/javascript">
    "use strict";

    // Add words for basic widgets
    $.extend(true, systemDictionary, {
        // Bars
        "src": {"en": "Source", "de": "Quelle", "ru": "Адрес"},
        "refreshInterval": {"en": "Refresh interval(ms)", "de": "Updatezeit(ms)", "ru": "Интервал обновления(ms)"},
        "is_comma": {"en": "Divider comma", "de": "Kamme als Trennung", "ru": "Запятая-разделитель"},
        "digits": {"en": "Digits after comma", "de": "Zeichen nach Komma", "ru": "Знаков после запятой"},
        "oid": {"en": "Object ID", "de": "Object ID", "ru": "ID Объекта"},
        "html_prepend": {"en": "Prepend value", "de": "Voranstellen HTML", "ru": "Префикс значения"},
        "html_append": {"en": "Append to value", "de": "HTML anhängen", "ru": "Суффикс значения"},
        "html_append_singular": {
            "en": "Append to value (Singular)",
            "de": "HTML anhängen (Singulär)",
            "ru": "Суффикс значения(един.ч.)"
        },
        "html_append_plural": {
            "en": "Append to value (Plural)",
            "de": "HTML anhängen(Plüral)",
            "ru": "Суффикс значения(множ.ч.)"
        },
        "factor": {"en": "Multiplex factor", "de": "Multiplikation", "ru": "Множитеть"},
        "class_true": {"en": "Class if quality 'true'", "de": "Kalsse bei Qualität 'true'", "ru": "Класс, если качество 'true'"},
        "class_false": {"en": "Class if quality 'false'", "de": "Kalsse bei Qualität 'false'", "ru": "Класс, если качество 'false'"},
        "test_html": {"en": "Text for test", "de": "Testtext", "ru": "Тестовый текст"},
        "html": {"en": "HTML", "de": "HTML", "ru": "HTML"},
        "oid-quality": {"en": "Quality ID", "de": "Qualität ID", "ru": "ID-Качество"},
        "title": {"en": "Title", "de": "Titel", "ru": "Заголовок"},
        "title_font": {"en": "Title font name", "de": "Titelschriftname", "ru": "Шрифт заголовка"},
        "title_color": {"en": "Title color", "de": "Titelfarbe", "ru": "Цвет заголовка"},
        "title_back": {"en": "Title backg. color", "de": "Titelhintergrund", "ru": "Цвет фона текста"},
        "title_top": {"en": "Title top padding", "de": "Titel-Oben-Abstand", "ru": "Отступ заголовка сверху"},
        "title_left": {"en": "Title left padding", "de": "Titel-Links-Abstand", "ru": "Отступ заголовка слева"},
        "header_height": {"en": "Header height", "de": "Kopfhöhe", "ru": "Высота заголовока"},
        "header_color": {"en": "Header color", "de": "Kopffarbe", "ru": "Цвет фона заголовка"},
        "refreshOnWakeUp": {"en": "Refresh on wake up", "de": "Update bei Aufwachen", "ru": "Обновлять при выходе из сна"},
        "refreshOnViewChange": {"en": "Refresh on view change", "de": "Update bei Viewwechsel", "ru": "Обновлять при смене страницы"},
        "src_": {"en": "Page URL, by value=", "de": "Frame URL falls Wert=", "ru": "URL страницы, значение="},
        "nav_view": {"en": "View to navigate", "de": "View zum Navigieren", "ru": "Перейти на страницу"},
        "group_effects": {"en": "Show/Hide Effects", "de": "Anzeige Effekte", "ru": "Эффекты появления/исчезнования"},
        "group_extended": {"en": "Extended settings", "de": "Erweiterte Eistellungen", "ru": "Расширенные настройки"},
        "body-background": {"en": "Background color by changing", "de": "Hintegrund by Wechsel", "ru": "Фон при смене страниц"},
        "sync": {"en": "Hide and show together:", "de": "Anzeigen und verbergen gleichzeitig", "ru": "Появления и исчезнование вместе"}
    });

    vis.binds.stateful = {
        view: function (el, viewArr, persistent) {
            var $this = $(el);
            var oid = $this.attr('data-oid');

            vis.states.bind(oid + ".val", function (e, newVal, oldVal) {
                var view = viewArr[newVal];
                if (!persistent) {
                    $this.parent().find('div.vis-view').remove();
                } else {
                    $this.parent().find('div.vis-view').hide().appendTo($('#vis_container'));
                }
                if (vis.views[view]) {
                    vis.renderView(view);
                    $('#visview_' + view).appendTo($this).show();
                }
            });
        },
        iframe: function (el, srcArr, refreshInterval) {
            var $this = $(el).parent().find('iframe');
            var oid = $this.attr('data-oid');

            vis.states.bind(oid + ".val", function (e, newVal, oldVal) {
                $this.attr('src', srcArr[newVal]);
            });

            if (vis.states[oid + '.val'] !== undefined) {
                $this.attr('src', srcArr[vis.states[oid + '.val']]);
            }

            if (refreshInterval > 0) {
                setInterval(function () {
                    var val = vis.states[oid + '.val'] || 0;
                    var src = srcArr[val];
                    $this.attr("src", src + (src.match(/\?/) ? '&' : '?') + '_vis_refts=' + ((new Date()).getTime()));
                }, refreshInterval);
            }
        },
        image: function (el, srcArr, refreshInterval) {
            var $this = $(el).parent().find("img");
            var oid = $this.attr('data-oid');

            vis.states.bind(oid + '.val', function (e, newVal, oldVal) {
                $this.attr('src', srcArr[newVal]);
            });

            if (vis.states[oid + '.val'] !== undefined) {
                $this.attr('src', srcArr[vis.states[oid + '.val']]);
            }

            if (refreshInterval > 0) {
                setInterval(function () {
                    var val = vis.states[oid + '.val'] || 0;
                    var src = srcArr[val];
                    $this.attr('src', src + (src.match(/\?/) ? '&' : '?') + '_vis_refts=' + ((new Date()).getTime()));
                }, refreshInterval);
            }
        }
    };
    vis.binds.container = function (el, view) {
        var $this = $(el);
        if (vis.views[view]) {
            vis.renderView(view);
            $('#visview_' + view).appendTo($this).show();
        }
    };
    vis.binds.basic = {
        filterDropdown: function (el, filters, hideEffect, hideDuration, showEffect, showDuration) {
            var $this = $(el);
            if (filters) {
                filters = filters.split(';');
                for (var i = 0; i < filters.length; i++) {
                    $this.find('select').append('<option value="' + filters[i] + '">' + filters[i] + '</option>');
                }
            }

            if (vis.viewsActiveFilter[vis.activeView]) {
                $this.find('select option[value="' + vis.viewsActiveFilter[vis.activeView] + '"]').attr('selected', true);
            }

            $this.find('select').change(function () {
                vis.changeFilter($this.find('select option:selected').val(), hideEffect, hideDuration, showEffect, showDuration);
            });

        },
        state: function (el, id) {
            var $this = $(el);
            var oid = (id ? id : $this.attr('data-oid'));
            var val = $this.attr('data-val');

            if (val === 'true')  val = true;
            if (val === 'false') val = false;

            $this.on('click', function (e) {
                if (!vis.editMode) {
                    vis.setValue($this.attr('data-oid'), val);
                }
            });
            // @geolin - auch das musste ich wieder entfernen weil es zu doppelter Ausführung geführt hat.
            /*
             $this.on('touchend',function (e) {
             if (!vis.editMode) {
             vis.setValue($this.attr('data-oid'), val);
             }
             });
             */
        },
        pressed: null,
        pressedNext: null,
        increment: function (el, minmax, delay, interval) {

            function fInterval($that) {
                vis.binds.basic.pressedNext = true;
                var oid = $that.attr('data-oid');
                if (!vis.editMode) {
                    var step = parseFloat($that.attr('data-vis-step'));
                    var tmp = parseFloat(vis.states[oid + '.val']) + step;
                    if (step < 0) {
                        if (tmp >= minmax) {
                            vis.setValue($that.attr('data-oid'), tmp);
                            vis.binds.basic.pressed = setTimeout(fInterval, interval, $that);
                        }
                    } else {
                        if (tmp <= minmax) {
                            vis.setValue($that.attr('data-oid'), tmp);
                            vis.binds.basic.pressed = setTimeout(function ($_that) {
                                fInterval($_that);
                            }, interval, $that);
                        }
                    }
                }
            }

            function intervalStart(e) {
                vis.binds.basic.pressedNext = false;
                var $this = $(this);
                var oid = $this.attr('data-oid');
                vis.binds.basic.pressed = setTimeout(fInterval, delay, $this);
            }

            $(el).click(function (e) {
                clearTimeout(vis.binds.basic.pressed);
                if (vis.binds.basic.pressedNext) {
                    vis.binds.basic.pressedNext = false;
                    return;
                }
                var $this = $(this);
                var oid = $this.attr('data-oid');
                if (!vis.editMode) {
                    var step = parseFloat($this.attr("data-vis-step")),
                            tmp = parseFloat(vis.states[oid + '.val']) + step;
                    if (step < 0) {
                        if (tmp >= minmax) {
                            vis.setValue($this.attr('data-oid'), tmp);
                        }
                    } else {
                        if (tmp <= minmax) {
                            vis.setValue($this.attr('data-oid'), tmp);
                        }
                    }
                }
            });

            if (interval) {
                $(el).on('mousedown', intervalStart)
                        .on('touchstart', intervalStart)
                        .on('touchend', function () {
                            clearTimeout(vis.binds.basic.pressed);
                        })
                        .on('mouseup', function () {
                            clearTimeout(vis.binds.basic.pressed);
                        });
            }
        },
        navigation: function (el, options) {
            var $this = $(el);
            $this.click(function (e) {
                if (!vis.editMode) {
                    if (options.background) {
                        $('body').css({background: options.background});
                    }
                    vis.changeView(options.nav_view, options.hideOptions, options.showOptions, options.sync);
                    //e.preventDefault();
                    //return false;
                }

            });
        },
        hideOnFalse: function (el) {
            var $this = $(el);
            var oid = $this.attr('data-oid');
            vis.states.bind(oid + ".val", function (e, newVal, oldVal) {
                if (newVal === null || newVal === false || newVal === 0 || newVal === "false" || parseInt(newVal, 10) == 0) {
                    if (!vis.editMode) {
                        $this.hide();
                    }
                } else {
                    $this.show();
                }
            });
            if (!vis.editMode) {
                var newVal = vis.states.attr(oid + ".val");
                if (newVal === null || newVal === false || newVal === 0 || newVal === "false" || parseInt(newVal, 10) == 0) {
                    $this.hide();
                }
            }
        },
        hideOnTrue: function (el) {
            var $this = $(el);
            var oid = $this.attr('data-oid');
            vis.states.bind(oid + ".val", function (e, newVal, oldVal) {
                if (newVal === true || parseFloat(newVal) > 0) {
                    if (!vis.editMode) {
                        $this.hide();
                    }
                } else {
                    $this.show();
                }
            });
            if (!vis.editMode) {
                if (parseFloat(vis.states.attr(oid + ".val")) != 0 && vis.states.attr(oid + ".val") !== false) {
                    $this.hide();
                }
            }
        },
        showOnValue: function (el, val) {
            var $this = $(el);
            var oid = $this.attr('data-oid');
            vis.states.bind(oid + ".val", function (e, newVal, oldVal) {
                if (newVal != val) {
                    if (!vis.editMode) {
                        $this.hide();
                    }
                } else {
                    $this.show();
                }
            });
            if (!vis.editMode) {
                if (vis.states.attr(oid + ".val") != val) {
                    $this.hide();
                }
            }
        },
        checkbox: function (el, numeric) {
            var $this = $(el);
            var oid = $this.attr('data-oid'); // Object ID
            var wid = $this.attr('data-oid-working'); // Work ID
            vis.states.bind(oid + '.val', function (e, newVal, oldVal) {
                // If still working
                if (wid && (vis.states.attr(wid + '.val') === true)) return;

                $this.prop('checked', !(newVal === false || parseFloat(newVal) === 0.0));
            });
            var val = vis.states.attr(oid + '.val');

            if (val === 'false') {
                val = false;
            } else if (val === 'true') {
                val = true;
            } else if (typeof val == 'string') {
                var f = parseFloat(val);
                if (f == val) {
                    val = f;
                } else if (val !== '') {
                    val = true;
                } else {
                    val = false;
                }
            }

            if (val > 0) $this.prop('checked', true);

            if (!vis.editMode) {
                $this.change(function () {
                    if ($this.prop('checked')) {
                        vis.setValue($this.attr('data-oid'), numeric ? 1 : true);
                    } else {
                        vis.setValue($this.attr('data-oid'), numeric ? 0 : false);
                    }
                });
            }
        },
        select: function (el) {
            var $this = $(el).prev();
            var id = $this.attr('data-oid');
            var val = vis.states[id + '.val'];

            if (val === 'false') {
                val = false;
            } else if (val === 'true') {
                val = true;
            } else if (typeof val == 'string') {
                var f = parseFloat(val);
                if (f == val) {
                    val = f;
                } else if (val !== '') {
                    val = true;
                } else {
                    val = false;
                }
            }
            $this.val(val ? 1 : 0);
            if (!vis.editMode) {
                $this.change(function () {
                    vis.setValue($this.attr('data-oid'), $this.find('option:selected').val());
                });
            }
            var oid = id;
            vis.states.bind(oid + '.val', function (e, newVal, oldVal) {
                if (newVal === 'false') {
                    newVal = false;
                } else if (newVal === 'true') {
                    newVal = true;
                } else if (typeof newVal == 'string') {
                    var f = parseFloat(newVal);
                    if (f == newVal) {
                        newVal = f;
                    } else if (newVal !== '') {
                        newVal = true;
                    } else {
                        newVal = false;
                    }
                }
                if (oldVal === 'false') {
                    oldVal = false;
                } else if (oldVal === 'true') {
                    oldVal = true;
                } else if (typeof oldVal == 'string') {
                    var f = parseFloat(oldVal);
                    if (f == oldVal) {
                        oldVal = f;
                    } else if (oldVal !== '') {
                        oldVal = true;
                    } else {
                        oldVal = false;
                    }
                }

                if (newVal == oldVal) return;

                if (newVal === "false" || newVal === false || parseFloat(newVal) == 0) {
                    if ($this.find('option[value="1"]').prop('selected')) {
                        $this.find('option[value="1"]').prop('selected', false);
                        $this.find('option[value="0"]').prop('selected', true);
                        $this.trigger('change');
                    }
                } else {
                    if ($this.find('option[value="0"]').prop('selected')) {
                        $this.find('option[value="0"]').prop('selected', false);
                        $this.find('option[value="1"]').prop('selected', true);
                        $this.trigger('change');
                    }
                }
            });
        },
        toggle: function (el) {
            var $this = $(el);
            var id = $this.attr('data-oid');

            function toggle() {
                var val = vis.states[id + '.val'];

                if (val === false || val === 'false') {
                    vis.setValue(id, true);
                } else if (val === true || val === 'true') {
                    vis.setValue(id, false);
                } else {
                    val = parseFloat(val);
                    if (val >= 0.5) {
                        val = 1;
                    } else {
                        val = 0;
                    }
                    vis.setValue(id, 1 - val);
                }
            }

            if (!vis.editMode) {
                // @geolin - musste das wieder entfernen - das führt zu doppelter Ausführung (Gerät geht kurz an und sofort wieder aus bzw umgekehrt)
                //$this.on('touchend', toggle);
                $this.on('click', toggle);
            }
        },
        iframeRefresh: function (el, src, refreshInterval) {
            if (!vis.editMode && refreshInterval > 0) {
                var $this = $(el).parent().find('iframe');
                setInterval(function () {
                    if ($this.is(':visible') && $this.parents(':hidden').length == 0) {
                        $this.attr('src', src + (src.match(/\?/) ? '&' : '?') + '_vis_refts=' + ((new Date()).getTime()));
                    }
                }, refreshInterval);
            }
        },
        imgRefresh: function (el, src, refreshInterval, refreshOnWakeUp, refreshOnViewChange) {
            var $this = $(el).parent().find('img');

            if (!vis.editMode && refreshOnViewChange) {
                var widgetView = vis.activeView;
                vis.navChangeCallbacks.push(function (view) {
                    if (view == widgetView) {
                        $this.attr('src', src + (src.match(/\?/) ? '&' : '?') + '_vis_refts=' + ((new Date()).getTime()));
                    }
                });
            }

            if (!vis.editMode && parseInt(refreshInterval, 10) > 0) {
                setInterval(function () {
                    if ($this.is(':visible') && $this.parents(':hidden').length == 0) {
                        $this.attr("src", src + (src.match(/\?/) ? '&' : '?') + '_vis_refts=' + ((new Date()).getTime()));

                    }
                }, refreshInterval);
            }
            if (refreshOnWakeUp) {
                //console.log("refreshOnWakeUp!");
                vis.onWakeUp(function () {
                    // TODO this does not work. :(
                    //console.log("wakeup refresh!");
                    $this.attr("src", src + (src.match(/\?/) ? '&' : '?') + '_vis_refts=' + ((new Date()).getTime()));
                    //console.log($this.attr("src"));
                });
            }
        },
        showSvg: function (myClass, view, wid, oid, opacity, svg_false, svg_true, style) {
            var obj = {myClass: myClass, view: view, wid: wid, oid: oid, opacity: opacity, svg_false: svg_false, svg_true: svg_true};
            if (document.getElementById(wid)) {
                $('#' + wid).remove();
            }
            var str = vis.states.attr(oid + '.val');
            var val = parseFloat(str);
            var sText = '<svg class="vis-widget ' + (myClass || "") + '" version="1.1" style="width:100px;height:100px" xmlns="http://www.w3.org/2000/svg" id="' + wid + '" data-oid="' + oid + '">';
            if (vis.editMode) {
                if (opacity === undefined || opacity === null || opacity === "") opacity = 1;

                if (parseFloat(opacity) < 0.2) opacity = 0.2;
            }
            if (val === 0 || str === "false" || str === false || str === null) {
                // try to analyse
                sText += svg_false;
            }
            else {
                sText += svg_true;
            }
            sText += '</svg>';
            $('#visview_' + view).append(sText);

            $('#' + wid).children().attr('data-wid', wid);
            $('#' + wid).children().attr('data-oid', oid);
            $('#' + wid).children().attr('opacity', opacity);
            if ($('#' + wid).children()[0]) {
                $('#' + wid).children()[0]._obj = obj;
            }

            if (style) {
                $('#' + wid).css(style);
            }

            if (!vis.editMode) {
                $('#' + wid).children().click(function () {
                    var $this = $(this);
                    var id = $this.attr('data-oid');
                    var val = vis.states[id + '.val'];
                    if (val === false || val === "false") {
                        vis.setValue(id, true);
                    } else if (val === true || val === "true") {
                        vis.setValue(id, false);
                    } else {
                        val = parseFloat(val);
                        if (val >= 0.5) {
                            val = 1;
                        } else {
                            val = 0;
                        }
                        vis.setValue(id, 1 - val);
                    }
                    var el = $('#' + obj.wid);
                    this._obj.style = {
                        "position": 'absolute',
                        top: el.position().top,
                        width: el.width(),
                        left: el.position().left,
                        height: el.height()
                    };
                    _setTimeout(function (obj) {
                        vis.binds.basic.showSvg(obj.myClass, obj.view, obj.wid, obj.oid, obj.opacity, obj.svg_false, obj.svg_true, obj.style);
                    }, 200, this._obj);
                });
            }
        },
        editNote: function (wid, max_width, min_width, min_height, oid) {
            if (vis.editMode) return;
            if (max_width != '') {
                max_width = parseInt(max_width, 10);
            } else {
                max_width = 400;
            }

            if (min_width != '') {
                min_width = parseInt(min_width, 10);
            } else {
                min_width = 40;
            }

            if (min_height != '') {
                min_height = parseInt(min_height, 10);
            } else {
                min_height = 15;
            }

            if (oid != '') {
                oid = parseInt(oid, 10);
            } else {
                oid = null;
            }

            var $this = $('#div_' + wid);
            $('body').append("<div id='dlg_" + wid + "' title='Edit note'>" +
            "<textarea style='width:95%;height:92%' id='text_" + wid + "'>" + $this.text() + "</textarea></div>");

            var buttons = {};
            buttons["Clear"] = function () {
                $('#text_' + $(this).attr('data-id')).val("");
            };

            buttons["Ok"] = function () {
                var dlg = $(this);
                var id = dlg.attr('data-id');
                var text = $('#text_' + dlg.attr('data-id')).val();
                //console.log(text + " " + dlg.attr('data-id'));
                text = text.replace("\n", "<br>\n");

                $('#div_' + dlg.attr('data-id')).html(text);
                if (text == "") {
                    $('#' + dlg.attr('data-id')).css({width: min_width, height: min_height});
                }
                else {
                    $('#' + dlg.attr('data-id')).css({width: max_width, height: 'auto'});
                }
                if (oid) {
                    vis.setValue(oid, text);
                }
                dlg.dialog("close");
                dlg.remove();
            };

            buttons["Cancel"] = function () {
                $(this).dialog("close");
                $(this).remove();
            };

            $('#dlg_' + wid).attr('data-id', wid).dialog({
                width: 500,
                height: 300,
                modal: true,
                buttons: buttons
            });
        },
        formatFloat: function (data) {
            if (vis.editMode && data.attr('test_html'))
                return data.attr('test_html');

            var val = (parseFloat(vis.states.attr(data.oid + ".val")) * data.factor).toFixed(data.digits);
            if (data.attr('is_comma')) {
                val = "" + val;
                val = val.replace('.', ',');
            }

            return val;
        }
    };

    $(document).mouseup(function () {
        if (vis.binds.basic.pressed) {
            clearInterval(vis.binds.basic.pressed);
        }
    });

</script>


<!-- Basic Widgets -->


<script type="text/ejs" id="tplHtml" class="vis-tpl" data-vis-set="basic" data-vis-name="static - HTML" data-vis-attrs="html">
    <div class="vis-widget <%== this.data.attr('class') %>" style="top:0px; left: 0px; width: 200px; height: 130px;" id="<%= this.data.attr('wid') %>">
        <div class="vis-widget-body">
            <%== this.data.attr('html') %>
        </div>
    </div>

</script>

<script type="text/ejs" id="tplIFrame" class="vis-tpl" data-vis-set="basic" data-vis-name="static - iFrame" data-vis-attrs="src;refreshInterval">
    <div class="vis-widget <%== this.data.attr('class') %>" style="top:0px; left: 0px; width: 600px; height: 320px;" id="<%= this.data.attr('wid') %>">
        <div class="vis-widget-body">
            <% if (vis.editMode) { %>
            <div class="editmode-helper" />
            <% } %>
            <iframe src="<%= this.data.attr('src') %>" style="position: absolute; border:0; padding:0; margin:0; width: 100%; height:100%;"></iframe>
            <div <%= (el) -> vis.binds.basic.iframeRefresh(el, data.attr("src"), data.attr("refreshInterval")) %>></div>
        </div>
    </div>

</script>

